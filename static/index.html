<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾½ç”°ç©ºæ¸¯ åˆ°ç€ä¾¿ä¸€è¦§</title>
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>
    <h1>ç¾½ç”°ç©ºæ¸¯ åˆ°ç€ä¾¿ä¸€è¦§</h1>
    <div style="text-align: center; margin-bottom: 20px;">
        <button id="refreshBtn" onclick="fetchFlights()" style="padding: 10px 20px; font-size: 16px; background-color: #0082f0; color: white; border: none; border-radius: 5px; cursor: pointer;">
            æ›´æ–°
        </button>
        <span id="lastUpdate" style="margin-left: 20px; color: #666; font-size: 14px;"></span>
    </div>
    <div id="loading" class="loading-message">ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="error" class="error-message" style="display: none;"></div>
    <table border="1" id="flightTable" style="display: none;">
        <thead>
            <tr>
                <th>é‹è¡ŒçŠ¶æ³</th><th>åˆ°ç€æ™‚åˆ»</th><th>å‡ºç™ºåœ°</th><th>æ©Ÿç¨®</th><th>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</th>
            </tr>
        </thead>
        <tbody>
            <!-- ãƒ‡ãƒ¼ã‚¿è¡ŒãŒã“ã“ã«å…¥ã‚‹ -->
        </tbody>
    </table>

    <script>
        async function fetchFlights() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const table = document.getElementById('flightTable');
            const refreshBtn = document.getElementById('refreshBtn');
            const lastUpdate = document.getElementById('lastUpdate');
            
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            table.style.display = 'none';
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'æ›´æ–°ä¸­...';

            try {
                // ç¾½ç”°ç©ºæ¸¯ã®å›½éš›ç·šåˆ°ç€ä¾¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                // CORSãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦å–å¾—
                const originalUrl = "https://tokyo-haneda.com/app_resource/flight/data/int/hdacfarv.json";
                const proxyUrls = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(originalUrl)}`,
                    `https://corsproxy.io/?${encodeURIComponent(originalUrl)}`,
                    `https://cors-anywhere.herokuapp.com/${originalUrl}`
                ];
                
                let resp;
                let lastError;
                
                // è¤‡æ•°ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’è©¦ã™
                for (const proxyUrl of proxyUrls) {
                    try {
                        resp = await fetch(proxyUrl);
                        if (resp.ok) {
                            break;
                        }
                    } catch (error) {
                        lastError = error;
                        continue;
                    }
                }
                
                if (!resp || !resp.ok) {
                    throw lastError || new Error(`HTTP error! status: ${resp ? resp.status : 'Unknown'}`);
                }
                
                const json = await resp.json();

                // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
                const today = new Date().toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\//g, '/');

                // æ­£è¦è¡¨ç¾ã®æº–å‚™
                const dateRegex = /\d{4}\/\d{2}\/\d{2}/;
                const timeRegex = /\b([01]?\d|2[0-3]):[0-5]\d\b/;

                const flights = [];

                // ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’å‡¦ç†
                if (json.flight_info && Array.isArray(json.flight_info)) {
                    json.flight_info.forEach(flightRow => {
                        const note = flightRow["å‚™è€ƒå’Œåç§°"] || "";
                        
                        // åˆ°ç€æ¸ˆã¿ã®ãƒ•ãƒ©ã‚¤ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        if (note.includes("åˆ°ç€æ¸ˆã¿")) {
                            return;
                        }

                        const scheduledTime = flightRow["å®šåˆ»"] || "";
                        const changedTime = flightRow["å¤‰æ›´æ™‚åˆ»"] || "";
                        const timeStr = arrivalTime(scheduledTime, changedTime);

                        // æ—¥ä»˜ã‚’ãƒã‚§ãƒƒã‚¯
                        const dateMatch = dateRegex.exec(timeStr);
                        if (dateMatch && dateMatch[0] === today) {
                            // æ™‚åˆ»ã‚’æŠ½å‡º
                            const timeMatch = timeRegex.exec(timeStr);
                            const arrivalTimeStr = timeMatch ? timeMatch[0] : "";

                            flights.push({
                                flight_status: (flightRow["å‚™è€ƒè¨³åç§°"] && flightRow["å‚™è€ƒè¨³åç§°"]["ja"]) || "",
                                arrival_time: arrivalTimeStr,
                                place_of_departure: flightRow["å‡ºç™ºåœ°ç©ºæ¸¯å’Œåç§°"] || "",
                                aircraft_code: flightRow["æ©Ÿç¨®ã‚³ãƒ¼ãƒ‰"] || "",
                                terminal: flightRow["ã‚¿ãƒ¼ãƒŸãƒŠãƒ«åŒºåˆ†"] || ""
                            });
                        }
                    });
                }

                // æ™‚åˆ»ã§ã‚½ãƒ¼ãƒˆ
                flights.sort((a, b) => a.arrival_time.localeCompare(b.arrival_time));

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
                updateTable(flights);
                
                loadingDiv.style.display = 'none';
                table.style.display = 'table';
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'æ›´æ–°';
                lastUpdate.textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP')}`;

            } catch (error) {
                console.error('ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                const sampleFlights = [
                    {
                        flight_status: "å®šåˆ»",
                        arrival_time: "13:15",
                        place_of_departure: "ã‚½ã‚¦ãƒ«",
                        aircraft_code: "A320",
                        terminal: "2"
                    },
                    {
                        flight_status: "é…å»¶",
                        arrival_time: "14:45",
                        place_of_departure: "å°åŒ—",
                        aircraft_code: "B737",
                        terminal: "3"
                    },
                    {
                        flight_status: "æ‰‹è·ç‰©å¼•æ¸¡ä¸­",
                        arrival_time: "15:20",
                        place_of_departure: "ä¸Šæµ·",
                        aircraft_code: "A330",
                        terminal: "2"
                    },
                    {
                        flight_status: "å®šåˆ»",
                        arrival_time: "16:30",
                        place_of_departure: "é¦™æ¸¯",
                        aircraft_code: "A350",
                        terminal: "3"
                    },
                    {
                        flight_status: "åˆ°ç€",
                        arrival_time: "17:10",
                        place_of_departure: "ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«",
                        aircraft_code: "B777",
                        terminal: "2"
                    },
                    {
                        flight_status: "å®šåˆ»",
                        arrival_time: "18:25",
                        place_of_departure: "ãƒãƒ³ã‚³ã‚¯",
                        aircraft_code: "A380",
                        terminal: "3"
                    },
                    {
                        flight_status: "é…å»¶",
                        arrival_time: "19:40",
                        place_of_departure: "ãƒãƒ‹ãƒ©",
                        aircraft_code: "B737",
                        terminal: "2"
                    }
                ];
                
                updateTable(sampleFlights);
                
                loadingDiv.style.display = 'none';
                errorDiv.innerHTML = `
                    <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</strong><br>
                    ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚<br><br>
                    <strong>è§£æ±ºæ–¹æ³•:</strong><br>
                    1. ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„<br>
                    2. å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„<br>
                    3. åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ãŠè©¦ã—ãã ã•ã„<br>
                    4. ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆã¯ã€HTTPSã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„<br><br>
                    <small>ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}</small>
                `;
                errorDiv.style.display = 'block';
                table.style.display = 'table';
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'æ›´æ–°';
                lastUpdate.textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP')} (ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿)`;
            }
        }

        function arrivalTime(scheduledTime, changedTime) {
            return changedTime || scheduledTime;
        }

        function updateTable(flights) {
            const tbody = document.querySelector('#flightTable tbody');
            tbody.innerHTML = ''; // ã‚¯ãƒªã‚¢

            if (flights.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 5;
                td.textContent = 'æœ¬æ—¥ã®åˆ°ç€ä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“';
                td.style.textAlign = 'center';
                td.style.padding = '20px';
                td.style.color = '#666';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            flights.forEach(flight => {
              const tr = document.createElement('tr');

              const td1 = document.createElement('td');
              td1.textContent = flight.flight_status;

              // ğŸ”½ å€¤ã«å¿œã˜ã¦èƒŒæ™¯è‰²ã‚’è¨­å®š
              switch (flight.flight_status) {
                case "é…å»¶":
                  td1.style.backgroundColor = "#fcccbe"; // è–„ç´…è‰²
                  break;
                case "æ‰‹è·ç‰©å¼•æ¸¡ä¸­":
                  td1.style.backgroundColor = "#ffff00"; // é»„è‰²
                  break;
                case "åˆ°ç€":
                  td1.style.backgroundColor = "#00ff00"; // ç·‘
                  break;
                case "æ¬ èˆª":
                  td1.style.backgroundColor = "#ff0000"; // èµ¤
                  td1.style.color = "#ffffff";
                  break;
                default:
                  td1.style.backgroundColor = "#ffffff"; // ç™½
              }

              const td2 = document.createElement('td');
              td2.textContent = flight.arrival_time;

              const td3 = document.createElement('td');
              td3.textContent = flight.place_of_departure;

              const td4 = document.createElement('td');
              td4.textContent = flight.aircraft_code;

              const td5 = document.createElement('td');
              td5.textContent = flight.terminal;
              td5.style.textAlign = "center"; // ä¸­å¤®æƒãˆ

              // ğŸ”½ å€¤ã«å¿œã˜ã¦èƒŒæ™¯è‰²ã‚’è¨­å®š
              switch (flight.terminal) {
                case "2":
                  td5.style.color = "#ffffff"; // ç™½
                  td5.style.backgroundColor = "#0082f0"; // é’
                  break;
                case "3":
                  td5.style.color = "#ffffff"; // ç™½
                  td5.style.backgroundColor = "#00afbd"; // ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚°ãƒªãƒ¼ãƒ³
                  break;
                default:
                  td5.style.backgroundColor = "#ffffff"; // ã‚°ãƒ¬ãƒ¼ï¼ˆä¸æ˜ãªå€¤ï¼‰
              }

              tr.appendChild(td1);
              tr.appendChild(td2);
              tr.appendChild(td3);
              tr.appendChild(td4);
              tr.appendChild(td5);

              tbody.appendChild(tr);
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‘¼ã³å‡ºã™
        window.onload = fetchFlights;
        
        // å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆ5åˆ†ã”ã¨ï¼‰
        setInterval(fetchFlights, 5 * 60 * 1000);
    </script>
  </body>
</html>
