<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾½ç”°ç©ºæ¸¯ åˆ°ç€ä¾¿ä¸€è¦§</title>
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>
    <h1>ç¾½ç”°ç©ºæ¸¯ åˆ°ç€ä¾¿ä¸€è¦§</h1>
    
    <!-- APIè¨­å®šãƒ‘ãƒãƒ« -->
    <div id="apiSettings" style="background-color: #f0f0f0; padding: 15px; margin-bottom: 20px; border-radius: 5px; display: none;">
        <h3>âš™ï¸ APIè¨­å®š</h3>
        <div style="margin-bottom: 10px;">
            <label for="apiSelect">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</label>
            <select id="apiSelect" style="margin-left: 10px; padding: 5px; width: 200px;">
                <option value="haneda">ç¾½ç”°ç©ºæ¸¯å…¬å¼API</option>
                <option value="sample">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿</option>
            </select>
        </div>
        <div id="apiDescription" style="font-size: 12px; color: #666; margin-bottom: 10px;">
            ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸å®‰å®šãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰
        </div>
        <button id="applySettings" style="padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">é©ç”¨</button>
        <button onclick="toggleSettings()" style="padding: 5px 10px; background-color: #666; color: white; border: none; border-radius: 3px; cursor: pointer; margin-left: 10px;">é–‰ã˜ã‚‹</button>
    </div>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <button id="refreshBtn" style="padding: 10px 20px; font-size: 16px; background-color: #0082f0; color: white; border: none; border-radius: 5px; cursor: pointer;">
            æ›´æ–°
        </button>
        <button id="settingsBtn" style="padding: 10px 20px; font-size: 16px; background-color: #666; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
            è¨­å®š
        </button>
        <span id="lastUpdate" style="margin-left: 20px; color: #666; font-size: 14px;"></span>
    </div>
    
    <div id="loading" class="loading-message">ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="error" class="error-message" style="display: none;"></div>
    <table border="1" id="flightTable" style="display: none;">
        <thead>
            <tr>
                <th>é‹è¡ŒçŠ¶æ³</th><th>åˆ°ç€æ™‚åˆ»</th><th>å‡ºç™ºåœ°</th><th>æ©Ÿç¨®</th><th>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</th>
            </tr>
        </thead>
        <tbody>
            <!-- ãƒ‡ãƒ¼ã‚¿è¡ŒãŒã“ã“ã«å…¥ã‚‹ -->
        </tbody>
    </table>

    <script>
        // APIè¨­å®š
        const API_CONFIGS = {
            haneda: {
                name: 'ç¾½ç”°ç©ºæ¸¯å…¬å¼API',
                url: 'https://tokyo-haneda.com/app_resource/flight/data/int/hdacfarv.json',
                parser: 'haneda',
                description: 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸å®‰å®šãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰'
            },
            sample: {
                name: 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿',
                url: null,
                parser: 'sample',
                description: 'å¸¸ã«å®‰å®šã—ãŸè¡¨ç¤ºï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰'
            }
        };

        let currentApiConfig = API_CONFIGS.haneda;

        function toggleSettings() {
            const settingsDiv = document.getElementById('apiSettings');
            settingsDiv.style.display = settingsDiv.style.display === 'none' ? 'block' : 'none';
        }

        function applySettings() {
            const apiSelect = document.getElementById('apiSelect');
            const selectedApi = apiSelect.value;
            const apiDescription = document.getElementById('apiDescription');
            
            currentApiConfig = API_CONFIGS[selectedApi];
            
            console.log('APIè¨­å®šã‚’å¤‰æ›´:', currentApiConfig.name);
            
            // èª¬æ˜æ–‡ã‚’æ›´æ–°
            apiDescription.textContent = currentApiConfig.description;
            
            // è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('apiSettings').style.display = 'none';
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
            fetchFlights();
        }

        // è¨­å®šå¤‰æ›´æ™‚ã®èª¬æ˜æ–‡æ›´æ–°
        function updateApiDescription() {
            const apiSelect = document.getElementById('apiSelect');
            const apiDescription = document.getElementById('apiDescription');
            const selectedApi = apiSelect.value;
            
            if (API_CONFIGS[selectedApi]) {
                apiDescription.textContent = API_CONFIGS[selectedApi].description;
            }
        }

        async function fetchFlights() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const table = document.getElementById('flightTable');
            const refreshBtn = document.getElementById('refreshBtn');
            const lastUpdate = document.getElementById('lastUpdate');
            
            // ç¾åœ¨æ™‚åˆ»ã‚’è¡¨ç¤º
            const startTime = new Date();
            loadingDiv.textContent = `ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­... (${startTime.toLocaleTimeString('ja-JP')})`;
            
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            table.style.display = 'none';
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'æ›´æ–°ä¸­...';

            try {
                let flights = [];
                let dataSource = '';

                if (currentApiConfig.parser === 'sample') {
                    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                    flights = getSampleFlights();
                    dataSource = currentApiConfig.name;
                    console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
                    
                    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯å°‘ã—é…å»¶ã‚’è¿½åŠ ã—ã¦èª­ã¿è¾¼ã¿æ„Ÿã‚’æ¼”å‡º
                    await new Promise(resolve => setTimeout(resolve, 500));
                } else {
                    // APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    console.log('APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™...');
                    flights = await fetchFromAPI(currentApiConfig.url);
                    dataSource = currentApiConfig.name;
                }

                // æˆåŠŸæ™‚ã®å‡¦ç†
                updateTable(flights);
                
                const endTime = new Date();
                const duration = ((endTime - startTime) / 1000).toFixed(1);
                
                loadingDiv.style.display = 'none';
                table.style.display = 'table';
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'æ›´æ–°';
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (flights.length > 0) {
                    lastUpdate.textContent = `æœ€çµ‚æ›´æ–°: ${endTime.toLocaleTimeString('ja-JP')} (${dataSource}) - ${flights.length}ä»¶ - ${duration}ç§’`;
                    lastUpdate.style.color = '#4CAF50'; // ç·‘è‰²
                } else {
                    lastUpdate.textContent = `æœ€çµ‚æ›´æ–°: ${endTime.toLocaleTimeString('ja-JP')} (${dataSource}) - æœ¬æ—¥ã®ä¾¿ãªã— - ${duration}ç§’`;
                    lastUpdate.style.color = '#FF9800'; // ã‚ªãƒ¬ãƒ³ã‚¸è‰²
                }

            } catch (error) {
                console.error('ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                const sampleFlights = getSampleFlights();
                updateTable(sampleFlights);
                
                const endTime = new Date();
                const duration = ((endTime - startTime) / 1000).toFixed(1);
                
                loadingDiv.style.display = 'none';
                errorDiv.innerHTML = `
                    <strong>âš ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</strong><br>
                    ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚<br><br>
                    <strong>ä½¿ç”¨ä¸­ã®API:</strong> ${currentApiConfig.name}<br>
                    <strong>ã‚¨ãƒ©ãƒ¼è©³ç´°:</strong> ${error.message}<br>
                    <strong>å–å¾—æ™‚é–“:</strong> ${duration}ç§’<br><br>
                    <strong>ğŸ’¡ è§£æ±ºæ–¹æ³•:</strong><br>
                    1. <button onclick="fetchFlights()" style="padding: 2px 6px; margin: 0 2px; cursor: pointer;">å†è©¦è¡Œ</button> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„<br>
                    2. è¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„<br>
                    3. ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„<br>
                    4. ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                `;
                errorDiv.style.display = 'block';
                table.style.display = 'table';
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'æ›´æ–°';
                lastUpdate.textContent = `æœ€çµ‚æ›´æ–°: ${endTime.toLocaleTimeString('ja-JP')} (ã‚¨ãƒ©ãƒ¼ - ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿) - ${duration}ç§’`;
                lastUpdate.style.color = '#f44336'; // èµ¤è‰²
            }
        }

        async function fetchFromAPI(originalUrl) {
            console.log('APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­:', originalUrl);
            
            // ãƒªãƒˆãƒ©ã‚¤è¨­å®š
            const maxRetries = 3;
            const retryDelay = 1000; // 1ç§’
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`è©¦è¡Œ ${attempt}/${maxRetries}`);
                    
                    // ã¾ãšç›´æ¥APIã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ
                    let resp;
                    try {
                        console.log('ç›´æ¥APIã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œä¸­...');
                        resp = await fetchWithTimeout(originalUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Cache-Control': 'no-cache'
                            }
                        }, 8000); // 8ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                        
                        if (resp.ok) {
                            console.log('ç›´æ¥APIã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸï¼');
                            const json = await resp.json();
                            return parseHanedaData(json);
                        } else {
                            throw new Error(`ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ${resp.status}`);
                        }
                    } catch (directError) {
                        console.log('ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—ã€ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¾ã™:', directError.message);
                        
                        // ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚Šä¿¡é ¼æ€§ã®é«˜ã„é †ã«ä¸¦ã¹æ›¿ãˆï¼‰
                        const proxyUrls = [
                            `https://api.allorigins.win/raw?url=${encodeURIComponent(originalUrl)}`,
                            `https://corsproxy.io/?${encodeURIComponent(originalUrl)}`,
                            `https://cors-anywhere.herokuapp.com/${originalUrl}`
                        ];
                        
                        let lastError = directError;
                        
                        // è¤‡æ•°ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’è©¦ã™
                        for (let i = 0; i < proxyUrls.length; i++) {
                            const proxyUrl = proxyUrls[i];
                            try {
                                console.log(`ãƒ—ãƒ­ã‚­ã‚· ${i + 1}/${proxyUrls.length} ã‚’è©¦è¡Œä¸­`);
                                resp = await fetchWithTimeout(proxyUrl, {
                                    method: 'GET',
                                    headers: {
                                        'Accept': 'application/json',
                                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                                    }
                                }, 10000); // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                                
                                if (resp.ok) {
                                    console.log(`ãƒ—ãƒ­ã‚­ã‚· ${i + 1} ã§æˆåŠŸ`);
                                    const json = await resp.json();
                                    return parseHanedaData(json);
                                }
                            } catch (error) {
                                console.log(`ãƒ—ãƒ­ã‚­ã‚· ${i + 1} ã§å¤±æ•—:`, error.message);
                                lastError = error;
                                continue;
                            }
                        }
                        
                        throw lastError || new Error(`ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚­ã‚·ã§å¤±æ•—`);
                    }
                } catch (error) {
                    console.log(`è©¦è¡Œ ${attempt} å¤±æ•—:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // æ¬¡ã®è©¦è¡Œã¾ã§å¾…æ©Ÿ
                    console.log(`${retryDelay}ms å¾…æ©Ÿå¾Œã€å†è©¦è¡Œã—ã¾ã™...`);
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                }
            }
        }

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãfetché–¢æ•°
        async function fetchWithTimeout(url, options, timeout) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                if (error.name === 'AbortError') {
                    throw new Error(`ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${timeout}ms`);
                }
                throw error;
            }
        }

        function parseHanedaData(json) {
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
            const today = new Date();
            const todayStr = today.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '/');

            console.log('ä»Šæ—¥ã®æ—¥ä»˜:', todayStr);

            // æ­£è¦è¡¨ç¾ã®æº–å‚™
            const dateRegex = /\d{4}\/\d{2}\/\d{2}/;
            const timeRegex = /\b([01]?\d|2[0-3]):[0-5]\d\b/;

            const flights = [];

            // ç¾½ç”°ç©ºæ¸¯APIã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¯¾å¿œ
            if (json.flight_info && Array.isArray(json.flight_info)) {
                console.log(`${json.flight_info.length}ä»¶ã®ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’å‡¦ç†ä¸­...`);
                
                json.flight_info.forEach((flightRow, index) => {
                    const note = flightRow["å‚™è€ƒå’Œåç§°"] || "";
                    
                    // åˆ°ç€æ¸ˆã¿ã®ãƒ•ãƒ©ã‚¤ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (note.includes("åˆ°ç€æ¸ˆã¿")) {
                        return;
                    }

                    const scheduledTime = flightRow["å®šåˆ»"] || "";
                    const changedTime = flightRow["å¤‰æ›´æ™‚åˆ»"] || "";
                    const timeStr = arrivalTime(scheduledTime, changedTime);

                    // æ—¥ä»˜ã‚’ãƒã‚§ãƒƒã‚¯
                    const dateMatch = dateRegex.exec(timeStr);
                    if (dateMatch && dateMatch[0] === todayStr) {
                        // æ™‚åˆ»ã‚’æŠ½å‡º
                        const timeMatch = timeRegex.exec(timeStr);
                        const arrivalTimeStr = timeMatch ? timeMatch[0] : "";

                        const flightStatus = (flightRow["å‚™è€ƒè¨³åç§°"] && flightRow["å‚™è€ƒè¨³åç§°"]["ja"]) || "";
                        const departure = flightRow["å‡ºç™ºåœ°ç©ºæ¸¯å’Œåç§°"] || "";
                        const aircraftCode = flightRow["æ©Ÿç¨®ã‚³ãƒ¼ãƒ‰"] || "";
                        const terminal = flightRow["ã‚¿ãƒ¼ãƒŸãƒŠãƒ«åŒºåˆ†"] || "";

                        flights.push({
                            flight_status: flightStatus,
                            arrival_time: arrivalTimeStr,
                            place_of_departure: departure,
                            aircraft_code: aircraftCode,
                            terminal: terminal
                        });
                    }
                });
            } else {
                console.warn('æœŸå¾…ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', json);
                throw new Error('ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒæœŸå¾…ã•ã‚Œã‚‹ã‚‚ã®ã¨ç•°ãªã‚Šã¾ã™');
            }

            console.log(`å‡¦ç†å®Œäº†: ${flights.length}ä»¶ã®ãƒ•ãƒ©ã‚¤ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);

            // æ™‚åˆ»ã§ã‚½ãƒ¼ãƒˆ
            flights.sort((a, b) => a.arrival_time.localeCompare(b.arrival_time));
            
            return flights;
        }

        function getSampleFlights() {
            return [
                {
                    flight_status: "å®šåˆ»",
                    arrival_time: "13:15",
                    place_of_departure: "ã‚½ã‚¦ãƒ«",
                    aircraft_code: "A320",
                    terminal: "2"
                },
                {
                    flight_status: "é…å»¶",
                    arrival_time: "14:45",
                    place_of_departure: "å°åŒ—",
                    aircraft_code: "B737",
                    terminal: "3"
                },
                {
                    flight_status: "æ‰‹è·ç‰©å¼•æ¸¡ä¸­",
                    arrival_time: "15:20",
                    place_of_departure: "ä¸Šæµ·",
                    aircraft_code: "A330",
                    terminal: "2"
                },
                {
                    flight_status: "å®šåˆ»",
                    arrival_time: "16:30",
                    place_of_departure: "é¦™æ¸¯",
                    aircraft_code: "A350",
                    terminal: "3"
                },
                {
                    flight_status: "åˆ°ç€",
                    arrival_time: "17:10",
                    place_of_departure: "ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«",
                    aircraft_code: "B777",
                    terminal: "2"
                },
                {
                    flight_status: "å®šåˆ»",
                    arrival_time: "18:25",
                    place_of_departure: "ãƒãƒ³ã‚³ã‚¯",
                    aircraft_code: "A380",
                    terminal: "3"
                },
                {
                    flight_status: "é…å»¶",
                    arrival_time: "19:40",
                    place_of_departure: "ãƒãƒ‹ãƒ©",
                    aircraft_code: "B737",
                    terminal: "2"
                }
            ];
        }

        function arrivalTime(scheduledTime, changedTime) {
            return changedTime || scheduledTime;
        }

        function updateTable(flights) {
            const tbody = document.querySelector('#flightTable tbody');
            tbody.innerHTML = ''; // ã‚¯ãƒªã‚¢

            if (flights.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 5;
                td.textContent = 'æœ¬æ—¥ã®åˆ°ç€ä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“';
                td.style.textAlign = 'center';
                td.style.padding = '20px';
                td.style.color = '#666';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            flights.forEach(flight => {
                const tr = document.createElement('tr');

                const td1 = document.createElement('td');
                td1.textContent = flight.flight_status;

                // å€¤ã«å¿œã˜ã¦èƒŒæ™¯è‰²ã‚’è¨­å®š
                switch (flight.flight_status) {
                    case "é…å»¶":
                        td1.style.backgroundColor = "#fcccbe"; // è–„ç´…è‰²
                        break;
                    case "æ‰‹è·ç‰©å¼•æ¸¡ä¸­":
                        td1.style.backgroundColor = "#ffff00"; // é»„è‰²
                        break;
                    case "åˆ°ç€":
                        td1.style.backgroundColor = "#00ff00"; // ç·‘
                        break;
                    case "æ¬ èˆª":
                        td1.style.backgroundColor = "#ff0000"; // èµ¤
                        td1.style.color = "#ffffff";
                        break;
                    default:
                        td1.style.backgroundColor = "#ffffff"; // ç™½
                }

                const td2 = document.createElement('td');
                td2.textContent = flight.arrival_time;

                const td3 = document.createElement('td');
                td3.textContent = flight.place_of_departure;

                const td4 = document.createElement('td');
                td4.textContent = flight.aircraft_code;

                const td5 = document.createElement('td');
                td5.textContent = flight.terminal;
                td5.style.textAlign = "center"; // ä¸­å¤®æƒãˆ

                // å€¤ã«å¿œã˜ã¦èƒŒæ™¯è‰²ã‚’è¨­å®š
                switch (flight.terminal) {
                    case "2":
                        td5.style.color = "#ffffff"; // ç™½
                        td5.style.backgroundColor = "#0082f0"; // é’
                        break;
                    case "3":
                        td5.style.color = "#ffffff"; // ç™½
                        td5.style.backgroundColor = "#00afbd"; // ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚°ãƒªãƒ¼ãƒ³
                        break;
                    default:
                        td5.style.backgroundColor = "#ffffff"; // ç™½
                }

                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tr.appendChild(td5);

                tbody.appendChild(tr);
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('refreshBtn').addEventListener('click', fetchFlights);
            document.getElementById('settingsBtn').addEventListener('click', toggleSettings);
            document.getElementById('applySettings').addEventListener('click', applySettings);
            
            // APIé¸æŠå¤‰æ›´æ™‚ã®èª¬æ˜æ–‡æ›´æ–°
            document.getElementById('apiSelect').addEventListener('change', updateApiDescription);
            
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã®ç›£è¦–
            window.addEventListener('online', function() {
                console.log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¾©æ—§ã—ã¾ã—ãŸ');
                document.getElementById('lastUpdate').textContent += ' (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§)';
                document.getElementById('lastUpdate').style.color = '#4CAF50';
                
                // è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
                setTimeout(fetchFlights, 1000);
            });
            
            window.addEventListener('offline', function() {
                console.log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
                document.getElementById('lastUpdate').textContent += ' (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³)';
                document.getElementById('lastUpdate').style.color = '#f44336';
            });
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            fetchFlights();
            
            // å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆ5åˆ†ã”ã¨ï¼‰
            setInterval(fetchFlights, 5 * 60 * 1000);
        });

        // ãƒšãƒ¼ã‚¸ã®å¯è¦–æ€§å¤‰æ›´ã‚’ç›£è¦–ï¼ˆã‚¿ãƒ–ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã¯æ›´æ–°ã‚’åœæ­¢ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('ãƒšãƒ¼ã‚¸ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸ');
            } else {
                console.log('ãƒšãƒ¼ã‚¸ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸ');
                // ãƒšãƒ¼ã‚¸ãŒå†åº¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸã‚‰æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const lastUpdateElement = document.getElementById('lastUpdate');
                const lastUpdateText = lastUpdateElement.textContent;
                
                // æœ€çµ‚æ›´æ–°ã‹ã‚‰5åˆ†ä»¥ä¸ŠçµŒéã—ã¦ã„ãŸã‚‰è‡ªå‹•æ›´æ–°
                if (lastUpdateText.includes('æœ€çµ‚æ›´æ–°:')) {
                    setTimeout(fetchFlights, 500);
                }
            }
        });
    </script>
  </body>
</html>
